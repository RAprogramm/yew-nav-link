name: CI

on:
  workflow_call:
    inputs:
      all-features:
        type: boolean
        default: true

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  fmt:
    name: Format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: ./.github/actions/setup-rust
        with:
          toolchain: nightly
          components: rustfmt

      - name: Check formatting
        run: cargo +nightly fmt --all -- --check

      - name: Summary
        if: always()
        run: |
          echo "## Format Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… All files formatted correctly" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Formatting issues found" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Run \`cargo +nightly fmt\` to fix" >> $GITHUB_STEP_SUMMARY
          fi

  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - uses: actions/checkout@v6
      - uses: ./.github/actions/setup-rust
        with:
          toolchain: stable
          components: clippy
      - uses: Swatinem/rust-cache@v2
        with:
          save-if: false

      - name: Install SARIF tools
        run: cargo install clippy-sarif sarif-fmt

      - name: Run Clippy
        run: |
          cargo clippy --workspace --all-targets ${{ inputs.all-features && '--all-features' || '' }} \
            --message-format=json -- -D warnings 2>&1 | clippy-sarif | tee clippy.sarif | sarif-fmt
        continue-on-error: true

      - name: Upload SARIF
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: clippy.sarif
          wait-for-processing: true

      - name: Check Clippy exit code
        run: |
          cargo clippy --workspace --all-targets ${{ inputs.all-features && '--all-features' || '' }} -- -D warnings

      - name: Summary
        if: always()
        run: |
          echo "## Clippy Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… No warnings or errors" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Issues found - check Security tab for details" >> $GITHUB_STEP_SUMMARY
          fi

  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: ./.github/actions/setup-rust
        with:
          toolchain: stable
      - uses: Swatinem/rust-cache@v2
        with:
          save-if: false

      - name: Install nextest
        uses: taiki-e/install-action@nextest

      - name: Run tests
        run: |
          cargo nextest run --workspace ${{ inputs.all-features && '--all-features' || '' }} \
            --no-fail-fast --profile ci --color=never 2>&1 | tee test-output.txt

      - name: Run doctests
        run: cargo test --doc --workspace ${{ inputs.all-features && '--all-features' || '' }}

      - name: Summary
        if: always()
        run: |
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… All tests passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Some tests failed" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Output" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          tail -20 test-output.txt >> $GITHUB_STEP_SUMMARY || true
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  coverage:
    name: Coverage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: ./.github/actions/setup-rust
        with:
          toolchain: stable
          components: llvm-tools-preview
      - uses: taiki-e/install-action@cargo-llvm-cov
      - uses: Swatinem/rust-cache@v2
        with:
          save-if: false

      - name: Generate coverage
        run: |
          cargo llvm-cov --workspace --all-features --lcov --output-path lcov.info
          cargo llvm-cov report --html --output-dir coverage-html

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage-html/
          retention-days: 7

      - name: Upload to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: lcov.info
          fail_ci_if_error: false

      - name: Summary
        if: always()
        run: |
          echo "## Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… Coverage report generated" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Coverage generation failed" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š [View detailed report on Codecov](https://codecov.io/gh/${{ github.repository }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¥ Coverage HTML report available in artifacts" >> $GITHUB_STEP_SUMMARY

  quality:
    name: Quality
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@v6

      - name: Run cargo-quality
        uses: RAprogramm/cargo-quality@v0
        with:
          path: src/
          fail_on_issues: true
          post_comment: ${{ github.event_name == 'pull_request' }}

      - name: Summary
        if: always()
        run: |
          echo "## Code Quality" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… Code quality standards met" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Quality issues found" >> $GITHUB_STEP_SUMMARY
          fi

  pr-analysis:
    name: PR Analysis
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Analyze PR size
        uses: RAprogramm/rust-prod-diff-checker@v1
        with:
          max_prod_lines: 100
          fail_on_exceed: true
          post_comment: true

      - name: Summary
        if: always()
        run: |
          echo "## PR Size Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… PR size within limits" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ PR exceeds size limits" >> $GITHUB_STEP_SUMMARY
          fi

  package:
    name: Package
    runs-on: ubuntu-latest
    needs: [fmt, clippy, test, quality]
    steps:
      - uses: actions/checkout@v6
      - uses: ./.github/actions/setup-rust
        with:
          toolchain: stable
      - uses: ./.github/actions/check-lockfile
      - uses: Swatinem/rust-cache@v2
        with:
          save-if: ${{ github.ref == 'refs/heads/main' }}

      - name: Package
        run: cargo package --locked

      - name: Upload package artifact
        uses: actions/upload-artifact@v4
        with:
          name: crate-package
          path: target/package/*.crate
          retention-days: 7

      - name: Summary
        if: always()
        run: |
          echo "## Package" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… Package created successfully" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Contents" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            cargo package --locked --list >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“¥ Crate available in artifacts" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Package failed" >> $GITHUB_STEP_SUMMARY
          fi
